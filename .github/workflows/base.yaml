name: CI
on:
    push:
      branches: [ "main" ]
    pull_request:
      branches: [ "main" ]

jobs:
    lint:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3
        - name: setup python 3.11
          uses: actions/setup-python@v4
          with:
            python-version: "3.11"
        - name: install pre-commit
          run: pip install pre-commit
        - name: run pre-commit
          run: pre-commit run --all-files

    tests:
      needs: lint
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3
        - name: setup python 3.11
          uses: actions/setup-python@v4
          with:
            python-version: "3.11"
        - name: install poetry
          run: curl -sSL https://install.python-poetry.org | python3 -
        - name: installing dependencies
          run: poetry install
        - name: installing playwright
          run: playwright install
        - name: run tests
          run: poetry run pytest --alluredir allure-results --reruns 1 tests
        - name: Archive allure-results artifacts
          uses: actions/upload-artifact@v3
          with:
            name: allure-results
            path: allure-results
            retention-days: 1

    generate-report:
      runs-on: ubuntu-latest
      needs: tests
      name: Generate report
      steps:
        - uses: actions/setup-java@v3
          with:
            distribution: 'microsoft' # See 'Supported distributions' for available options
            java-version: '17'
        - run: sudo wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz && sudo tar -zxvf allure-2.25.0.tgz -C /opt/ && sudo ln -s /opt/allure-2.25.0/bin/allure /usr/bin/allure
        - name: Download all workflow run artifacts
          uses: actions/download-artifact@v3
        - run: allure generate -c allure-results -o _site
        - name: Store generated report
          uses: actions/upload-artifact@v3
          with:
            name: _site
            path:
              _site
            retention-days: 1

    publish-report:
      runs-on: ubuntu-latest
      needs: generate-report
      name: Report publication
      steps:
        - name: Download all workflow run artifacts
          uses: actions/download-artifact@v3
        - name: Upload Pages artifact
          uses: actions/upload-pages-artifact@v2
        - name: Deploy to GitHub Pages
          id: deployment
          uses: actions/deploy-pages@v1.2.9
